<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Student Directory | Rahbar Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta content="Admin Student Directory for Rahbar Application" name="description" />
    <meta content="Coderthemes" name="author" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- App favicon -->
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/favicon.ico') }}" />

    <!-- App css -->
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet" type="text/css" id="bootstrap-stylesheet" />
    <link href="{{ url_for('static', filename='css/icons.min.css') }}" rel="stylesheet" type="text/css" />
    <link href="{{ url_for('static', filename='css/app.min.css') }}" rel="stylesheet" type="text/css" id="app-stylesheet" />

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap4.min.css">

    <style>
      .footer {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: #f8f9fa;
        padding: 10px 20px;
        text-align: center;
        font-size: 14px;
        color: #6c757d;
        border-top: 1px solid #ddd;
        z-index: 1030;
      }
      .content-page { padding-bottom: 70px; }

      /* --- Glassy Modal Styles --- */
      .glassy-modal .modal-content {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.4);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        border-radius: 15px;
      }
      .glassy-modal .modal-header {
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        background: rgba(248, 249, 250, 0.8);
        border-top-left-radius: 15px;
        border-top-right-radius: 15px;
      }
      .glassy-modal .modal-footer {
        border-top: 1px solid rgba(0, 0, 0, 0.1);
        background: rgba(248, 249, 250, 0.8);
        border-bottom-left-radius: 15px;
        border-bottom-right-radius: 15px;
      }
      
      /* --- SCROLL FIX FOR MANUAL REGISTRATION MODAL --- */
      #manualAddStudentModal .modal-body {
        max-height: 75vh;
        overflow-y: auto;
        overflow-x: hidden;
      }
      
      .nav-pills .nav-link.active, .nav-pills .show>.nav-link {
        background-color: #28a745;
        box-shadow: 0 4px 6px rgba(40, 167, 69, 0.3);
      }
      .nav-pills .nav-link {
        color: #495057;
        font-weight: 600;
        border-radius: 8px;
        margin-right: 5px;
      }
      
      .editable-field:disabled {
        background-color: transparent;
        border: none;
        font-weight: 600;
        color: #333;
        padding-left: 0;
        appearance: none;
        -webkit-appearance: none;
      }
      .editable-field:not(:disabled) {
        background-color: #fff;
        border: 1px solid #ced4da;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.075);
      }
    </style>
  </head>

  <body>
    <div id="wrapper">
      <div class="navbar-custom">
        <div class="d-flex justify-content-between align-items-center w-100">
          <div><h6 class="page-title mb-0">Admin Panel</h6></div>
          <div><a href="{{ url_for('main.homepage') }}" class="text-success"><h4>Rahbar Scholarship Information Management System</h4></a></div>
          <ul class="list-unstyled topnav-menu mb-0">
            <li class="dropdown notification-list">
              <a class="nav-link dropdown-toggle nav-user waves-effect" data-toggle="dropdown" href="#" role="button">
                <img src="{{ url_for('static', filename='images/users/avatar-1.jpg') }}" alt="user-image" class="rounded-circle" />
                <span class="d-none d-sm-inline-block ml-1">{{ admin.name }}</span>
              </a>
              <div class="dropdown-menu dropdown-menu-right profile-dropdown">
                <a href="{{ url_for('auth.logout') }}" class="dropdown-item notify-item"><i class="mdi mdi-logout-variant"></i><span>Logout</span></a>
              </div>
            </li>
          </ul>
        </div>
      </div>

      <!-- Sidebar Start -->
        <!-- ========== Left Sidebar Start ========== -->
      <div class="left-side-menu">
        <div class="slimscroll-menu">
          <!--- Sidemenu -->
          <div id="sidebar-menu">
            <ul class="metismenu" id="side-menu">
              <li class="menu-title">Navigation</li>
              <!-- Dashboard -->
              <li>
                <a
                  href="{{ url_for('admin.admin_dashboard') }}"
                  class="waves-effect waves-light"
                >
                  <i class="mdi mdi-view-dashboard"></i>
                  <span>Dashboard</span>
                </a>
              </li>
              <!-- Manage Users -->
              <li>
                <a
                  href="{{ url_for('admin.manage_users') }}"
                  class="waves-effect waves-light"
                >
                  <i class="mdi mdi-account-multiple"></i>
                  <span>Manage Users</span>
                </a>
              </li>
              <!-- System Configuration -->
              <li>
                <a
                  href="{{ url_for('admin.system_configuration') }}"
                  class="waves-effect waves-light"
                >
                  <i class="mdi mdi-settings"></i>
                  <span>Payment Configuration</span>
                </a>
              </li>
              <!-- Generate Reports -->
              <li>
                <a
                  href="{{ url_for('admin.admin_generate_reports') }}"
                  class="waves-effect waves-light"
                >
                  <i class="mdi mdi-chart-bar"></i>
                  <span>Generate Reports</span>
                </a>
              </li>
              <!-- Application Period -->
              <li>
                <a
                  href="{{ url_for('admin.manage_application_period') }}"
                  class="waves-effect waves-light"
                >
                  <i class="mdi mdi-calendar"></i>
                  <span>Application Period</span>
                </a>
              </li>
              <!-- In admin/dashboard.html -->
              <li>
                <a
                  href="{{ url_for('admin.manage_rcc_centers') }}"
                  class="waves-effect waves-light"
                >
                  <i class="mdi mdi-bank"></i>
                  <span>Manage RCC Centers</span>
                </a>
              </li>
              <li>
                <a
                  href="{{ url_for('admin.manage_courses') }}"
                  class="waves-effect waves-light"
                >
                  <i class="mdi mdi-book-open"></i>
                  <span>Manage Courses</span>
                </a>
              </li>
              <li>
                <a
                  href="{{ url_for('admin.manage_sponsorships') }}"
                  class="waves-effect waves-light active"
                >
                  <i class="mdi mdi-account-switch"></i>
                  <span>Manage Sponsorships</span>
                </a>
              </li>
              <li><a href="{{ url_for('admin.student_directory') }}" class="waves-effect waves-light active"><i class="mdi mdi-account-details"></i><span>Student Directory</span></a></li>
            </ul>
          </div>
          <!-- End Sidebar -->
        </div>
      </div>
      <!-- Left Sidebar End -->

      <div class="content-page">
        <div class="content">
          <div class="container-fluid">
            <div class="row">
              <div class="col-12"><div class="page-title-box"><h4 class="page-title">Student Directory & Full Details</h4></div></div>
            </div>

            <!-- Filters Section -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="header-title">Filters & Search</h4>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-group"><label>Search (Any Field)</label><input type="text" id="searchInput" class="form-control" placeholder="Name, Email, Phone..."></div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group"><label>Institution</label>
                                        <select id="filterInstitution" class="form-control">
                                            <option value="">All Institutions</option>
                                            {% for inst in institutions %}<option value="{{ inst.institution_id }}">{{ inst.institution_name }}</option>{% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group"><label>Course</label>
                                        <select id="filterCourse" class="form-control">
                                            <option value="">All Courses</option>
                                            {% for course in courses %}<option value="{{ course.course_id }}">{{ course.course_name }}</option>{% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group" style="margin-top: 28px;">
                                        <button class="btn btn-primary" id="btnApplyFilters">Apply Filters</button>
                                        <button class="btn btn-secondary" id="btnResetFilters">Reset</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table Section -->
            <div class="row">
              <div class="col-12">
                <div class="card">
                  <div class="card-body">
                    <h4 class="header-title mb-4">All Registered Students</h4>
                    <button type="button" class="btn btn-success mr-2" data-toggle="modal" data-target="#uploadCsvModal"><i class="mdi mdi-file-upload"></i> Upload CSV</button>
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#manualAddStudentModal"><i class="mdi mdi-account-plus"></i> Register New Student</button>
                    
                    <div class="table-responsive mt-4">
                        <table id="studentsTable" class="table table-bordered table-striped dt-responsive nowrap" style="width:100%">
                          <thead>
                            <tr>
                              <th>Student Ref_Id</th><th>Name</th><th>Email</th><th>Phone</th><th>Sponsor ID</th><th>Sponsor Name</th><th>Status</th><th>Actions</th>
                            </tr>
                          </thead>
                          <tbody></tbody>
                        </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div> 
        </div> 
        <footer class="footer"><p class="mb-0">Developed by <strong>Cognifly AI System</strong></p></footer>
      </div>
    </div>

    <!-- STUDENT DETAILS MODAL -->
    <div class="modal fade glassy-modal" id="studentDetailsModal" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title text-success"><i class="mdi mdi-account-details"></i> Student Profile: <span id="modalTitleName"></span></h4>
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
          </div>
          <div class="modal-body">
            <ul class="nav nav-pills nav-fill mb-3" id="pills-tab" role="tablist">
              <li class="nav-item"><a class="nav-link active" data-toggle="pill" href="#pills-profile">Personal Info</a></li>
              <li class="nav-item"><a class="nav-link" data-toggle="pill" href="#pills-course">Course Assignment</a></li>
              <li class="nav-item"><a class="nav-link" data-toggle="pill" href="#pills-bank">Bank Details</a></li>
              <li class="nav-item"><a class="nav-link" data-toggle="pill" href="#pills-payment">Schedule & History</a></li>
              <li class="nav-item"><a class="nav-link" data-toggle="pill" href="#pills-docs">Documents</a></li>
            </ul>
            <div class="tab-content" id="pills-tabContent">
              <div class="tab-pane fade show active" id="pills-profile">
                <form id="editStudentForm">
                  <input type="hidden" id="editUserId">
                  <div class="row">
                    <div class="col-md-6 form-group"><label>Full Name</label><input type="text" class="form-control editable-field" id="editName" disabled></div>
                    <div class="col-md-6 form-group"><label>Email</label><input type="email" class="form-control editable-field" id="editEmail" disabled></div>
                    <div class="col-md-6 form-group"><label>Phone</label><input type="text" class="form-control editable-field" id="editPhone" disabled></div>
                    <div class="col-md-6 form-group">
                      <label>Chapter</label>
                      <select class="form-control editable-field" id="editRegion" disabled>
                        <option value="North">North</option><option value="South">South</option><option value="East">East</option><option value="West">West</option><option value="Central">Central</option><option value="Jeddah">Jeddah</option><option value="Riyadh">Riyadh</option><option value="Dammam">Dammam</option>
                      </select>
                    </div>
                    <div class="col-md-6 form-group"><label>Father's Name</label><input type="text" class="form-control editable-field" id="editFatherName" disabled></div>
                    <div class="col-md-6 form-group"><label>Mother's Name</label><input type="text" class="form-control editable-field" id="editMotherName" disabled></div>
                    <div class="col-12 form-group"><label>Address</label><textarea class="form-control editable-field" id="editAddress" rows="2" disabled></textarea></div>
                  </div>
                </form>
              </div>
              <div class="tab-pane fade" id="pills-course">
                <div class="row">
                  <div class="col-md-6">
                    <div class="card bg-light card-body">
                        <h5 class="card-title text-success"><i class="mdi mdi-school"></i> Academic Status</h5>
                        <div class="form-group"><label>Institution</label>
                            <select class="form-control editable-field" id="editInstitution" disabled>
                                <option value="">Not Assigned</option>
                                {% for inst in institutions %}<option value="{{ inst.institution_id }}">{{ inst.institution_name }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="form-group"><label>Course</label>
                            <select class="form-control editable-field" id="editCourse" disabled><option value="">Not Assigned</option></select>
                        </div>
                        <p class="mb-0"><strong>Assigned Date:</strong> <span id="viewAssignedAt">N/A</span></p>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="card bg-light card-body">
                        <h5 class="card-title text-info"><i class="mdi mdi-account-heart"></i> Sponsorship</h5>
                        <p><strong>Sponsor Name:</strong> <span id="viewSponsorName">Unassigned</span></p>
                        <p><strong>Email:</strong> <span id="viewSponsorEmail">--</span></p>
                        <button class="btn btn-sm btn-outline-danger mt-2" id="unmapSponsorBtn">Unassign Sponsor</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="tab-pane fade" id="pills-bank">
                <form id="editBankForm">
                  <div class="row">
                    <div class="col-md-6 form-group"><label>Account Holder Name</label><input type="text" class="form-control editable-field" id="editBankAcName" disabled></div>
                    <div class="col-md-6 form-group"><label>Bank Name</label><input type="text" class="form-control editable-field" id="editBankName" disabled></div>
                    <div class="col-md-6 form-group"><label>Account Number</label><input type="text" class="form-control editable-field" id="editBankAcNum" disabled></div>
                    <div class="col-md-6 form-group"><label>IFSC Code</label><input type="text" class="form-control editable-field" id="editBankIfsc" disabled></div>
                  </div>
                </form>
              </div>
              <div class="tab-pane fade" id="pills-payment">
                <h5 class="text-primary">Calculated Payment Schedule (Quarterly)</h5>
                <div id="paymentScheduleContainer"><div class="alert alert-info">Loading schedule...</div></div>
                <hr class="mt-4">
                <h5 class="text-dark">Official Transaction History</h5>
                <div class="table-responsive"><table class="table table-sm table-hover">
                    <thead><tr><th>Date</th><th>Amount</th><th>Status</th><th>By</th><th>Receipt</th></tr></thead>
                    <tbody id="paymentHistoryBody"></tbody>
                </table></div>
              </div>
              <div class="tab-pane fade" id="pills-docs">
                <div class="table-responsive"><table class="table table-striped">
                    <thead><tr><th>Date</th><th>Year/Session</th><th>Marks</th><th>File</th></tr></thead>
                    <tbody id="docsTableBody"></tbody>
                </table></div>
              </div>
            </div>
          </div>
          <div class="modal-footer justify-content-between">
            <div><button type="button" class="btn btn-danger" id="deactivateBtn" style="display:none;">Deactivate User</button><button type="button" class="btn btn-success" id="activateBtn" style="display:none;">Activate User</button></div>
            <div>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-info" id="enableEditBtn"><i class="mdi mdi-pencil"></i> Edit Details</button>
                <button type="button" class="btn btn-success" id="saveChangesBtn" style="display:none;"><i class="mdi mdi-content-save"></i> Save Profile & Assignment</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- UPLOAD CSV MODAL -->
    <div class="modal fade" id="uploadCsvModal" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glassy-modal">
          <div class="modal-header bg-dark text-white"><h5 class="modal-title">Bulk Upload</h5><button type="button" class="close text-white" data-dismiss="modal">×</button></div>
          <form action="{{ url_for('admin.bulk_upload_students') }}" method="POST" enctype="multipart/form-data">
            <div class="modal-body">
              <div class="alert alert-info py-2"><small>Required: Student Reference, Student Name, Year Admission, etc.</small></div>
              <div class="form-group"><label>Select CSV File</label><input type="file" class="form-control-file" name="file" accept=".csv" required></div>
            </div>
            <div class="modal-footer"><button type="submit" class="btn btn-success">Upload</button></div>
          </form>
        </div>
      </div>
    </div>

    <!-- MANUAL ADD STUDENT MODAL -->
    <div class="modal fade" id="manualAddStudentModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content glassy-modal">
                <div class="modal-header bg-primary text-white"><h4 class="modal-title">Manual Student Registration</h4><button type="button" class="close text-white" data-dismiss="modal">×</button></div>
                <form action="{{ url_for('admin.manual_add_student') }}" method="POST">
                    <div class="modal-body">
                        <h5 class="text-primary border-bottom pb-2">Step 1: Profile</h5>
                        <div class="row">
                            <div class="col-md-3 form-group"><label>Student Ref_Id</label><input type="text" name="user_id" class="form-control" placeholder="M001-2024" required></div>
                            <div class="col-md-4 form-group"><label>Full Name</label><input type="text" name="name" class="form-control" required></div>
                            <div class="col-md-3 form-group"><label>Email</label><input type="email" name="email" class="form-control" placeholder="Optional"></div>
                            <div class="col-md-2 form-group"><label>Sex</label><select name="sex" class="form-control"><option value="M">Male</option><option value="F">Female</option></select></div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 form-group"><label>Region</label><select name="region" class="form-control"><option value="North">North</option><option value="South">South</option><option value="East">East</option><option value="West">West</option><option value="Jeddah">Jeddah</option><option value="Riyadh">Riyadh</option></select></div>
                            <div class="col-md-3 form-group"><label>Admission Year</label><input type="number" name="year" class="form-control" value="2024"></div>
                            <div class="col-md-3 form-group"><label>Student Mobile</label><input type="text" name="phone" class="form-control" required></div>
                            <div class="col-md-3 form-group"><label>Rahbar Alumnus?</label><select name="alumnus" class="form-control"><option value="N">No</option><option value="Y">Yes</option></select></div>
                        </div>
                        <h5 class="text-primary border-bottom pb-2 mt-3">Step 2: Family & Socio-Economic</h5>
                        <div class="row">
                            <div class="col-md-3 form-group"><label>Father Name</label><input type="text" name="father_name" class="form-control"></div>
                            <div class="col-md-3 form-group"><label>Father Profession</label><input type="text" name="father_profession" class="form-control"></div>
                            <div class="col-md-3 form-group"><label>Mother Name</label><input type="text" name="mother_name" class="form-control"></div>
                            <div class="col-md-3 form-group"><label>Mother Profession</label><input type="text" name="mother_profession" class="form-control"></div>
                            <div class="col-md-4 form-group"><label>Annual Salary (INR)</label><input type="number" name="salary" class="form-control" value="0"></div>
                            <div class="col-md-4 form-group"><label>Father Mobile</label><input type="text" name="father_mobile" class="form-control"></div>
                            <div class="col-md-4 form-group"><label>Mother Mobile</label><input type="text" name="mother_mobile" class="form-control"></div>
                            <div class="col-12 form-group"><label>Full Address</label><textarea name="address" class="form-control" rows="2"></textarea></div>
                        </div>
                        <h5 class="text-primary border-bottom pb-2 mt-3">Step 3: Academic & Sponsorship</h5>
                        <div class="row">
                            <div class="col-md-4 form-group"><label>College</label>
                                <select name="institution_id" id="manualInst" class="form-control">
                                    <option value="">Select College</option>
                                    {% for inst in institutions %}<option value="{{ inst.institution_id }}">{{ inst.institution_name }}</option>{% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4 form-group"><label>Course</label><select name="course_id" id="manualCourse" class="form-control"><option value="">Select Course</option></select></div>
                            <div class="col-md-4 form-group"><label>RCC Name/Center</label><input type="text" name="rcc_name" class="form-control"></div>
                            <div class="col-md-12 form-group"><label>Sponsor Reference (Enter Sponsor User_ID)</label><input type="text" name="sponsor_id" class="form-control" placeholder="Search/Enter Sponsor ID"></div>
                        </div>
                        <h5 class="text-primary border-bottom pb-2 mt-3">Step 4: Bank Details</h5>
                        <div class="row">
                            <div class="col-md-4 form-group"><label>Bank Name</label><input type="text" name="bank_name" class="form-control"></div>
                            <div class="col-md-4 form-group"><label>Account No</label><input type="text" name="acc_no" class="form-control"></div>
                            <div class="col-md-4 form-group"><label>IFSC Code</label><input type="text" name="ifsc" class="form-control"></div>
                        </div>
                    </div>
                    <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary">Register Student</button></div>
                </form>
            </div>
        </div>
    </div>

    <!-- ADMIN RECORD PAYMENT MODAL -->
    <div class="modal fade" id="adminPaymentModal" tabindex="-1" role="dialog" style="z-index: 1065;">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-success text-white"><h5>Process Official Payment</h5><button type="button" class="close text-white" data-dismiss="modal">×</button></div>
          <form id="adminPaymentForm" enctype="multipart/form-data">
            <div class="modal-body">
              <input type="hidden" name="action_type" id="payActionType"><input type="hidden" name="payment_id" id="payPaymentId"><input type="hidden" name="grantee_id" id="payGranteeId">
              <div class="alert alert-info py-2" id="payBankDetailsText"></div>
              <div class="form-group"><label>Amount (INR)</label><input type="number" step="0.01" class="form-control" name="amount" id="payAmount" required></div>
              <div class="form-group"><label>Payment Date</label><input type="date" class="form-control" name="payment_date" id="payDate" required></div>
              <div class="form-group"><label>Status</label><select class="form-control" name="status" id="payStatus"><option value="Paid">Paid</option><option value="Pending">Pending</option></select></div>
              <div class="form-group"><label>Receipt</label><input type="file" class="form-control-file" name="receipt"></div>
            </div>
            <div class="modal-footer"><button type="submit" class="btn btn-success">Save Record</button></div>
          </form>
        </div>
      </div>
    </div>

    <!-- JS SECTION -->
    <script src="{{ url_for('static', filename='js/vendor.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/app.min.js') }}"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap4.min.js"></script>

    <script>
      const allCourses = {{ courses|tojson|safe if courses else '[]' }};
      var currentStudentId = null;
      var uploadsBaseUrl = "{{ url_for('admin.uploaded_file', filename='') }}";

      $(document).ready(function() {
        var table = $('#studentsTable').DataTable({
            "processing": true, "serverSide": true,
            "ajax": { "url": "{{ url_for('admin.get_all_students_data') }}", "data": function(d) { d.institution_id = $('#filterInstitution').val(); d.course_id = $('#filterCourse').val(); } },
            "columns": [
                { "data": "user_id" }, { "data": "name" }, { "data": "email" }, { "data": "phone" }, 
                { "data": "sponsor_id", "render": d => d || '-' }, { "data": "sponsor_name", "render": d => d || '<span class="text-danger">Unassigned</span>' },
                { "data": "status", "render": d => `<span class="badge badge-${d.toLowerCase()=='active'?'success':'danger'}">${d}</span>` },
                { "data": null, "orderable": false, "render": (d,t,row) => `<button class="btn btn-sm btn-primary view-details-btn" data-id="${row.user_id}"><i class="mdi mdi-eye"></i> View Details</button>` }
            ]
        });

        $('#btnApplyFilters').click(() => table.ajax.reload());
        $('#btnResetFilters').click(() => { $('#filterInstitution, #filterCourse, #searchInput').val(''); table.ajax.reload(); });

        $('#studentsTable tbody').on('click', '.view-details-btn', function () { loadStudentDetails($(this).data('id')); });

        function loadStudentDetails(userId) {
            currentStudentId = userId;
            $('.editable-field').prop('disabled', true);
            $('#saveChangesBtn').hide(); $('#enableEditBtn').show();
            $.get(`/api/student/details/${userId}`, function(res) {
                const p = res.profile; const b = res.bank || {}; const c = res.course || {}; const s = res.sponsor || {};
                $('#modalTitleName').text(p.name);
                $('#editUserId').val(p.user_id); $('#editName').val(p.name); $('#editEmail').val(p.email);
                $('#editPhone').val(p.phone); $('#editRegion').val(p.region);
                $('#editFatherName').val(p.father_name); $('#editMotherName').val(p.mother_name); $('#editAddress').val(p.address);
                $('#editStudentForm').data('father_mobile', p.father_mobile).data('mother_mobile', p.mother_mobile);
                $('#editInstitution').val(c.institution_id || "");
                updateCourseDropdown(c.institution_id, c.course_id);
                $('#viewAssignedAt').text(c.assigned_at ? new Date(c.assigned_at).toLocaleDateString() : 'N/A');
                if (p.status.toLowerCase() === 'active') { $('#deactivateBtn').show(); $('#activateBtn').hide(); } 
                else { $('#deactivateBtn').hide(); $('#activateBtn').show(); }
                $('#viewSponsorName').text(s.name || 'Unassigned');
                $('#editBankAcName').val(b.account_name); $('#editBankName').val(b.bank_name);
                $('#editBankAcNum').val(b.account_number); $('#editBankIfsc').val(b.ifsc_code);
                let hHtml = '';
                res.payments.forEach(pay => {
                    let link = pay.receipt_url ? `<a href="${uploadsBaseUrl}${pay.receipt_url.split('/').pop()}" target="_blank">View</a>` : '-';
                    hHtml += `<tr><td>${new Date(pay.payment_date).toLocaleDateString()}</td><td>₹${pay.amount}</td><td><span class="badge badge-info">${pay.status}</span></td><td>${pay.grantor_name || 'System'}</td><td>${link}</td></tr>`;
                });
                $('#paymentHistoryBody').html(hHtml || '<tr><td colspan="5" class="text-center">No history.</td></tr>');
                let dHtml = '';
                res.documents.forEach(doc => {
                    dHtml += `<tr><td>${new Date(doc.created_at).toLocaleDateString()}</td><td>${doc.year}</td><td>${doc.marks}</td><td><a href="${uploadsBaseUrl}${doc.file_path.split('/').pop()}" target="_blank" class="btn btn-xs btn-primary">File</a></td></tr>`;
                });
                $('#docsTableBody').html(dHtml || '<tr><td colspan="4" class="text-center">No documents.</td></tr>');
                generateSchedule(c, res.payments, b, p);
                $('#studentDetailsModal').modal('show');
            });
        }

        function updateCourseDropdown(instId, selectedCourseId) {
            const courseSelect = $('#editCourse').html('<option value="">Select Course</option>');
            if (!instId) return;
            allCourses.filter(c => c.institution_id == instId).forEach(c => {
                const opt = $('<option></option>').val(c.course_id).text(c.course_name);
                if (c.course_id == selectedCourseId) opt.prop('selected', true);
                courseSelect.append(opt);
            });
        }

        $('#manualInst').on('change', function() {
            const instId = $(this).val();
            const courseSelect = $('#manualCourse').html('<option value="">Select Course</option>');
            if (!instId) return;
            allCourses.filter(c => c.institution_id == instId).forEach(c => {
                courseSelect.append($('<option></option>').val(c.course_id).text(c.course_name));
            });
        });

        function generateSchedule(course, payments, bank, profile) {
            const container = $('#paymentScheduleContainer');
            if (!course.assigned_at) { container.html('<div class="alert alert-warning">Not assigned.</div>'); return; }
            const dbRecords = payments.sort((a,b) => new Date(a.payment_date) - new Date(b.payment_date));
            const start = new Date(course.assigned_at);
            const quarterlyAmt = (parseFloat(profile.annual_schedule_amount) / 4).toFixed(2);
            const totalInst = Math.floor((parseInt(course.number_of_semesters) / 2) * 4);
            let html = '<div class="table-responsive"><table class="table table-bordered text-center"><thead><tr class="thead-light"><th>#</th><th>Due Date</th><th>Amount</th><th>Status</th><th>Action</th></tr></thead><tbody>';
            let nextFound = false;
            for (let i = 1; i <= totalInst; i++) {
                let dueDate = new Date(start); dueDate.setMonth(start.getMonth() + (3 * i));
                let status = ''; let btn = ''; let rowClass = '';
                if (i <= dbRecords.length) {
                    let rec = dbRecords[i-1];
                    rowClass = rec.status.toLowerCase()==='paid'?'table-success':'';
                    status = rec.status.toLowerCase()==='paid'?'Paid':rec.status;
                    btn = `<button class="btn btn-xs btn-outline-info edit-pay" data-id="${rec.payment_id}" data-amt="${rec.amount}" data-date="${new Date(rec.payment_date).toISOString().split('T')[0]}" data-status="${rec.status}">Edit</button>`;
                } else if (!nextFound) {
                    nextFound = true;
                    status = dueDate < new Date() ? 'Overdue' : 'Due';
                    btn = `<button class="btn btn-sm btn-success pay-now" data-amt="${quarterlyAmt}" data-bank="${bank.bank_name || 'N/A'} (Acc: ${bank.account_number || 'N/A'})">Pay Now</button>`;
                } else { status = 'Scheduled'; btn = '<button class="btn btn-xs btn-light" disabled>Pay Now</button>'; }
                html += `<tr class="${rowClass}"><td>${i}</td><td>${dueDate.toLocaleDateString()}</td><td>₹${quarterlyAmt}</td><td>${status}</td><td>${btn}</td></tr>`;
            }
            container.html(html + '</tbody></table></div>');
        }

        $(document).on('click', '.pay-now', function() {
            $('#payActionType').val('create'); $('#payGranteeId').val(currentStudentId);
            $('#payAmount').val($(this).data('amt')); $('#payBankDetailsText').text("Paying: " + $(this).data('bank'));
            $('#payDate').val(new Date().toISOString().split('T')[0]); $('#adminPaymentModal').modal('show');
        });

        $(document).on('click', '.edit-pay', function() {
            $('#payActionType').val('edit'); $('#payPaymentId').val($(this).data('id'));
            $('#payAmount').val($(this).data('amt')); $('#payDate').val($(this).data('date'));
            $('#payStatus').val($(this).data('status')); $('#adminPaymentModal').modal('show');
        });

        $('#enableEditBtn').click(function() { $('.editable-field').prop('disabled', false); $(this).hide(); $('#saveChangesBtn').show(); });
        
        $('#saveChangesBtn').click(function() {
            const data = { 
                user_id: currentStudentId, name: $('#editName').val(), email: $('#editEmail').val(), phone: $('#editPhone').val(), 
                region: $('#editRegion').val(), institution_id: $('#editInstitution').val(), course_id: $('#editCourse').val(), 
                account_number: $('#editBankAcNum').val(), bank_name: $('#editBankName').val(), ifsc_code: $('#editBankIfsc').val(), account_name: $('#editBankAcName').val(),
                father_name: $('#editFatherName').val(), mother_name: $('#editMotherName').val(), address: $('#editAddress').val(),
                father_mobile: $('#editStudentForm').data('father_mobile'), mother_mobile: $('#editStudentForm').data('mother_mobile'),
                status: $('#deactivateBtn').is(':visible') ? 'Active' : 'Inactive'
            };
            $.ajax({ url: "/api/student/update", method: 'POST', contentType: 'application/json', data: JSON.stringify(data), success: function() { alert('Success!'); $('#studentDetailsModal').modal('hide'); table.ajax.reload(null, false); } });
        });

        $('#adminPaymentForm').submit(function(e) {
            e.preventDefault();
            $.ajax({ url: "/api/payment/record_action", type: 'POST', data: new FormData(this), contentType: false, processData: false, success: function() { alert('Saved!'); $('#adminPaymentModal').modal('hide'); loadStudentDetails(currentStudentId); } });
        });
      });
    </script>
  </body>
</html>